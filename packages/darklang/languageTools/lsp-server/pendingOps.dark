module Darklang.LanguageTools.LspServer.PendingOps

// Get recent package ops from the database
let handleGetPendingOpsRequest
  (state: LspState)
  (requestID: JsonRPC.RequestId)
  (params: Stdlib.Option.Option<JsonRPC.Request.RequestParams>)
  : LspState =
  // Get last 20 recent ops
  let ops = SCM.PackageOps.getRecent 20L

  let body =
    ops
    |> Stdlib.List.map (fun op ->
      let opData = Builtin.jsonSerialize<LanguageTools.ProgramTypes.PackageOp> op
      let label = PrettyPrinter.ProgramTypes.PackageOp.packageOp op
      Json.Object [ ("op", Json.String opData); ("label", Json.String label) ])
    |> Json.Array

  let responseJson =
    let requestID = Stdlib.Option.Option.Some(requestID)
    (JsonRPC.Response.Ok.make requestID body)
    |> Stdlib.AltJson.format

  logAndSendToClient responseJson
  state
