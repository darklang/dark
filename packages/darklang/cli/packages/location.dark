module Darklang.Cli.Packages.Create.Location

type ParsedLocation =
  { owner: String
    modules: List<String>
    name: String }


/// Parse a location string relative to current position
/// Handles absolute paths (/Darklang.Foo.bar) and relative paths (bar, Foo.bar)
let parseRelativeTo
  (currentLocation: Packages.PackageLocation)
  (location: String)
  : Stdlib.Result.Result<ParsedLocation, String> =
  // Get the current module path
  let currentPath = Traversal.getCurrentModulePath currentLocation

  // Check if it's an absolute path
  let isAbsolute = Stdlib.String.startsWith location "/"

  let parts =
    if isAbsolute then
      // Remove leading slash and split
      let withoutSlash = Stdlib.String.dropFirst location 1L
      Stdlib.String.split withoutSlash "."
    else
      // Relative path - combine current path with relative path
      let relativeParts = Stdlib.String.split location "."
      Stdlib.List.append currentPath relativeParts

  match parts with
  | [] -> Stdlib.Result.Result.Error "Empty location"
  | [_] -> Stdlib.Result.Result.Error "Location must have at least owner and name"
  | owner :: rest ->
    let name = (Stdlib.List.last rest) |> Builtin.unwrap
    let modules = Stdlib.List.dropLast rest

    Stdlib.Result.Result.Ok
      (ParsedLocation { owner = owner; modules = modules; name = name })


/// Parse an absolute location like "Darklang.Foo.Bar.baz"
/// Returns owner="Darklang", modules=["Foo", "Bar"], name="baz"
let parse (location: String) : Stdlib.Result.Result<ParsedLocation, String> =
  let parts = Stdlib.String.split location "."

  match parts with
  | [] -> Stdlib.Result.Result.Error "Empty location"
  | [_] -> Stdlib.Result.Result.Error "Location must have at least owner and name"
  | owner :: rest ->
    let name = (Stdlib.List.last rest) |> Builtin.unwrap
    let modules = Stdlib.List.dropLast rest

    Stdlib.Result.Result.Ok
      (ParsedLocation { owner = owner; modules = modules; name = name })


/// Convert to ProgramTypes.PackageLocation
let toPackageLocation (loc: ParsedLocation) : LanguageTools.ProgramTypes.PackageLocation =
  LanguageTools.ProgramTypes.PackageLocation
    { owner = loc.owner; modules = loc.modules; name = loc.name }
