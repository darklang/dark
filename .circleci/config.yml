version: 2.1
executors:
  my-executor:
    docker:
      - image: docker:stable-git

commands:
  copy-into-container:
    steps:
      - run:
        # https://circleci.com/docs/2.0/building-docker-images/#mounting-folders
          name: Copy app directory into dev container
          command: |
            docker create -v /home/dark/app --name vols alpine:3.4 /bin/true
            docker cp . vols:/home/dark/app
            # set the ownership of all this
            docker run -i --volumes-from vols alpine sh -c "adduser -D -u 1000 dark; chown -R dark /home/dark/app"

  initialize:
    steps:
      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Install outer container utilities
          # coreutils for gnu date
          # bash for scripts
          command: |
            apk add --update bash coreutils nginx jq
      # # Setup for daily/weekly caches
      # - run: date +"%F" > today-timestamp
      # - run: date +"%F" -d "today - 1 days" > minus1-timestamp
      # - run: date +"%F" -d "today - 2 days" > minus2-timestamp
      # - run: date +"%F" -d "today - 3 days" > minus3-timestamp
      # - run: date +"%F" -d "today - 4 days" > minus4-timestamp
      # - run: date +"%F" -d "today - 5 days" > minus5-timestamp
      # - run: date +"%F" -d "today - 6 days" > minus6-timestamp
      # - run: date +"%F" -d "today - 7 days" > minus7-timestamp
      #
      # # main build
      # - restore_cache:
      #     keys:
      #       - v1-build-{{ checksum "today-timestamp" }}
      #       - v1-build-{{ checksum "minus1-timestamp" }}
      #       - v1-build-{{ checksum "minus2-timestamp" }}
      #       - v1-build-{{ checksum "minus3-timestamp" }}
      #       - v1-build-{{ checksum "minus4-timestamp" }}
      #       - v1-build-{{ checksum "minus5-timestamp" }}
      #       - v1-build-{{ checksum "minus6-timestamp" }}
      #       - v1-build-{{ checksum "minus7-timestamp" }}
      #
      # - run:
      #     name: Maybe clear caches
      #     # Since we don't checksum the cache on its contents, it may
      #     # continue to grow. As a result, let's clear the cache weekly.
      #     # We store the day the cache was built in the cache. If the
      #     # cache was built on friday, and today is not Friday, then
      #     # it's the first build after last week, and clear it.
      #     command: |
      #       if [[ `date +"%A"` != "Friday" && `cat server/_build/CACHE_DAY` == "Friday" ]]; then
      #         echo "Clearing caches"
      #         rm -Rf client/elm-stuff
      #         rm -Rf client/tests/elm-stuff
      #         rm -Rf server/_build
      #       else
      #         echo "Not clearing caches"
      #       fi
      #       mkdir -p server/_build
      #       date +"%A" > server/_build/CACHE_DAY
      #


# TODO:
# make the separate jobs work
# enable caching and artifacts again for each job
# split the integration tests by test time
# optimize workflow

jobs:
  build:
    executor: my-executor
    steps:
      - initialize
      - checkout
      - copy-into-container
      - run: scripts/builder --compile --test

      - run:
          name: Copy out compiled binaries
          when: always
          command: docker cp vols:/home/dark/app/server/ server/

      # - save_cache:
      #     when: always
      #     paths: [ "server/_build" ]
      #     key: v1-build-{{ checksum "today-timestamp" }}

      - persist_to_workspace: { root: ".", paths: "." }


      # - run:
      #     name: Copy out artifacts
      #     when: always
      #     command: |
      #       mkdir -p artifacts
      #       docker cp vols:/home/dark/app/rundir artifacts/rundir1/
      #
      #
      # - store_artifacts:
      #     path: artifacts
      # - store_test_results:
      #     path: artifacts/rundir1/test_results

  integration-tests:
    executor: my-executor
    steps:
      - initialize
      - attach_workspace:
          at: .
      - copy-into-container
      - run:
          command: NEVER_REBUILD_DOCKER=1 scripts/builder --serve
          background: true

      # run this here so we save a little time waiting for the server to
      # be ready.
      - run: nginx -t -c $(pwd)/scripts/support/nginx-toplevel.conf -g "pid $(pwd)/rundir/nginx.pid;"

      # The 2nd invocation of builder isn't free.
      - run: |
          scripts/wait-until-container-ready
          scripts/wait-until-server-ready

      - run: scripts/run-in-docker integration-tests/run.sh

  deploy:
    executor: my-executor
    steps:
      - initialize
      - attach_workspace:
          at: .
      - copy-into-container
      - run: scripts/run-in-docker scripts/gcp-build-containers
      - run: scripts/deploy-from-circle



# NOTES:
# - test splitting command something like: grep ^test integration-tests/tests.js | sed "s/.*'\(.*\)'.*/\1/" | circleci tests spli t --split-by=timings
# - to get timing data, in CI try this:  circleci tests split --show-counts --verbose
#   - it hung for me
# - deploy doesn't work because we dont copy stuff over
# - there's a 4m delay before integration tests start because we recompile stuff from scratch. Reuse by saving to workspace after build.
# - there's a 2m pause before testcafe starts
# - is deploy set to just master branch? if not weird
#
workflows:
  version: 2
  build-and-deploy:
    jobs:
      - build
      - integration-tests:
          requires:
            - build
      - deploy:
          requires:
            - integration-tests
            - build
