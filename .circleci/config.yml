version: 2.1

# Config for CI/CD pipeline

# There is a strong connection between this file and the equivalent files for
# running Dark in dev, which are scripts/builder and
# scripts/build/_build-server. Generally, if you add something to this file,
# there's an equivalent to be added in one of those files.

executors:
  simple-executor:
    docker:
      - image: cimg/base:2023.09
    environment:
      IN_DEV_CONTAINER: true
  node-executor:
    docker:
      - image: cimg/node:20.17
    environment:
      IN_DEV_CONTAINER: true
  in-container:
    working_directory: ~/app
    environment:
      IN_DEV_CONTAINER: true
    docker:
      # DOCKERFILE_REPO: see Dockerfile note about how this is built.
      - image: darklang/dark-base:7dc786d

commands:
  show-large-files-and-directories:
    steps:
      - run:
          # show any file or directory over 50M in size
          # note alpine find doesn't support +50M here
          name: show large files and directories
          command: |
            find ~ -size +51200k -exec du -h {} \;
            du -ht 50M

  ##########################
  # Check the worktree
  ##########################
  assert-clean-worktree:
    steps:
      - run:
          name: Assert the worktree is clean
          command: "bash -c '[[ -z $(git status -s) ]] && echo Workdir is clean || { echo Workdir is not clean:; git status -s; $(exit 1); }'"

  ##########################
  # Checkout - need to remove some things for a clean checkout
  ##########################
  darkcheckout:
    steps:
      # To get ownership right when mounting volumes in local development, the
      # container adds a bunch of directories within ~/app. However, in Circle,
      # we don't use volumes and the container is loaded before the git
      # checkout, which complains if the checkout directory is not empty. So
      # let's delete those first.
      - run: rm -Rf /home/dark/app/*
      - checkout

  ##########################
  # Setup app
  ##########################
  setup-app:
    steps:
      - run:
          name: Setup build environment
          command: |
            set -x
            scripts/devcontainer/_setup-circleci-environment
            scripts/devcontainer/_create-app-directories
            scripts/devcontainer/_create-cache-directories
            scripts/devcontainer/_setup-hosts
            # Build process statements moved to build-backend
            env

##########################
# Actual workflow
##########################
jobs:
  #
  ## All jobs related to the 'build' of Darklang

  static-checks:
    executor: in-container
    steps:
      - darkcheckout
      - run: scripts/linting/shellchecker
      # There are currently no yaml files
      # - run: scripts/linting/yamllinter
      - run: scripts/formatting/format check

  # Build parser
  build-parser:
    executor: in-container
    steps:
      - darkcheckout
      - setup-app
      # Generate checksum for parser cache based on files that affect the build
      - run: |
          cat tree-sitter-darklang/grammar.js \
              tree-sitter-darklang/src/scanner.c \
              tree-sitter-darklang/package.json \
              tree-sitter-darklang/package-lock.json \
              <(date +"%U%Y") | shasum > ../parser-checksum
      - restore_cache:
          keys:
            - v2-parser-{{ checksum "../parser-checksum" }}
      - run:
          name: Check if parser already built
          command: |
            if [ -f backend/src/LibTreeSitter/lib/tree-sitter-darklang.so ]; then
              echo "Parser already built from cache"
              if [ "${CIRCLE_BRANCH}" = "main" ]; then
                # Check if cross-compiled files exist
                if ls backend/src/LibTreeSitter/lib/tree-sitter-darklang-*.* 1> /dev/null 2>&1; then
                  echo "Cross-compiled binaries exist, skipping build"
                  echo "export SKIP_PARSER_BUILD=true" >> $BASH_ENV
                fi
              else
                echo "export SKIP_PARSER_BUILD=true" >> $BASH_ENV
              fi
            fi
      - run: |
          if [ "$SKIP_PARSER_BUILD" != "true" ]; then
            ./scripts/build/build-tree-sitter.sh
          fi
      - run:
          command: |
            if [ "$SKIP_PARSER_BUILD" != "true" ]; then
              if [ "${CIRCLE_BRANCH}" = "main" ]; then
                ./scripts/build/build-parser --cross-compile
              else
                ./scripts/build/build-parser
              fi
            fi
      - run: cd tree-sitter-darklang && npm run test
      - save_cache:
          paths:
            - tree-sitter-darklang/node_modules
            - tree-sitter-darklang/build
            - tree-sitter-darklang/src
            - tree-sitter-darklang/tree-sitter-darklang.so
            - tree-sitter-darklang/xplat-builds
            - backend/src/LibTreeSitter/lib
          key: v2-parser-{{ checksum "../parser-checksum" }}
      - persist_to_workspace:
          root: "."
          paths:
            - backend/src/LibTreeSitter/lib
            - tree-sitter-darklang/src

  # Build server binaries and run tests
  # Cleanup: consider splitting into (1) build debug (2) prepare .db (3) build release
  build-backend:
    executor: in-container
    resource_class: xlarge
    steps:
      - darkcheckout
      # Set the timestamp to the commit time. This allows timestamp-based build tools
      # like .NET to use their incremental build feature. Without this, the checkout
      # time is always newer than the cached object file, and files are always
      # rebuilt
      # Currently disabled, as it was causing issues failures within
      # Serialization.Tests.fs where the allowedTypes for serializers did not match
      # what tests expected (and what files were persisted in backend/testfiles/serialization-artifacts).
      # TODO: think through an alternative or more nuanced approach.
      #- run: git restore-mtime
      - setup-app
      - attach_workspace: { at: "." }
      - run: ls -l backend/src/LibTreeSitter/lib
      - run:
          name: Setup backend build environment
          command: |
            set -x

      # The date is used to get a fresh cache each week
      - run: shasum backend/paket.lock backend/global.json <(date +"%U%Y") > ../checksum
      - restore_cache:
          keys:
            - v5-backend-{{ checksum "../checksum" }}
            # Fails often enough that it's better not to have a fallback
      - show-large-files-and-directories
      # For tests
      - run: ./scripts/build/_dotnet-wrapper tool restore
      - run: ./scripts/build/_dotnet-wrapper paket restore
      # DebugType=None and DebugSymbol=false tells dotnet not to copy .pdb files to publish/

      # Setup database for tests that need it
      - run:
          name: Build LocalExec for migrations (debug mode fine)
          command: ./scripts/build/_dotnet-wrapper build src/LocalExec/LocalExec.fsproj
      - run:
          name: Run migrations to create database
          command: scripts/run-local-exec migrations run
      - run:
          name: Load packages into database
          command: scripts/build/reload-packages

      - run: ./scripts/build/_dotnet-wrapper publish -c Release fsdark.sln /p:DebugType=None /p:DebugSymbols=false

      - run: scripts/run-backend-tests --published

      ## TODO: too many race conditions. Bring back later
      # Test package manager/cli integration works
      # - run: scripts/run-backend-server --published
      # - run: sleep 5 # let migrations run
      # - run: scripts/build/reload-packages --published
      # - run: scripts/run-cli @Darklang.Stdlib.Float.add 1.9 2.0

      - assert-clean-worktree
      - persist_to_workspace:
          root: "."
          paths:
            # Just enough for deploy
            - backend/Build/out/BwdServer/Release/net8.0/linux-x64/publish/
      - show-large-files-and-directories
      - save_cache:
          paths:
            - backend/Build/obj
            - /home/dark/.nuget
            - tree-sitter-darklang/node_modules
            - tree-sitter-darklang/build
          key: v5-backend-{{ checksum "../checksum" }}
      - store_artifacts: { path: rundir }
      - store_test_results: { path: rundir/test_results }

  # Build cli binaries
  build-cli:
    executor: in-container
    resource_class: xlarge
    steps:
      - darkcheckout
      - setup-app
      - attach_workspace: { at: "." }

      # The date is used to get a fresh cache each week
      - run: shasum backend/paket.lock backend/global.json <(date +"%U%Y") > ../checksum
      - restore_cache:
          keys:
            - v4-cli-{{ checksum "../checksum" }}
            # Fails often enough that it's better not to have a fallback
      - show-large-files-and-directories
      # For tests
      - run: ./scripts/build/_dotnet-wrapper tool restore
      - run: ./scripts/build/_dotnet-wrapper paket restore

      # The CLI embeds the Sqlite data.db,
      # so we need to get a copy ready first.
      - run:
          name: Build LocalExec for migrations (debug mode fine)
          command: ./scripts/build/_dotnet-wrapper build src/LocalExec/LocalExec.fsproj
      - run:
          name: Run migrations to create database
          command: scripts/run-local-exec migrations run
      - run:
          name: Load packages into database
          command: scripts/build/reload-packages

      - assert-clean-worktree
      - run:
          command: |
            if [ "${CIRCLE_BRANCH}" = "main" ]; then
              ./scripts/build/build-release-cli-exes.sh --cross-compile
            else
              ./scripts/build/build-release-cli-exes.sh
            fi
      - persist_to_workspace:
          root: "."
          paths:
            - clis
      - show-large-files-and-directories
      - save_cache:
          paths:
            - backend/Build/obj
            - /home/dark/.nuget
            - tree-sitter-darklang/node_modules
            - tree-sitter-darklang/build
          key: v4-cli-{{ checksum "../checksum" }}
      - store_artifacts: { path: rundir }
      - store_artifacts: { path: clis }
      - store_test_results: { path: rundir/test_results }

  #
  # This is used as a no-op dependency for other jobs, to prevent "deploy things"
  # from happening before the "build things" are done
  ok-to-deploy:
    executor: simple-executor
    steps:
      - run:
          name: No operation
          command: "true"

  #
  # Jobs to run on `main` after we've confirmed the build is OK
  # Publish cli via github releases
  # Uses lightweight container - only needs curl, jq, bash
  publish-github-release:
    executor: simple-executor
    steps:
      - checkout
      - run:
          name: Install jq
          command: sudo apt-get update && sudo apt-get install -y jq
      - attach_workspace: { at: "." }
      - run: ./scripts/deployment/publish-github-release

  # Publish VS Code Extension to the Marketplace
  # Uses lightweight node container - only needs npm, vsce, jq
  publish-vs-code-extension:
    executor: node-executor
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            sudo apt-get update && sudo apt-get install -y jq
            sudo npm install -g @vscode/vsce
      - attach_workspace: { at: "." }
      - run: ./scripts/deployment/publish-vs-code-extension

workflows:
  build-and-deploy:
    jobs:
      # Build jobs
      - static-checks
      - build-parser
      - build-backend:
          requires: [build-parser]
      - build-cli:
          requires: [build-parser]

      # Gate for release jobs
      - ok-to-deploy:
          requires:
            - static-checks
            - build-parser
            - build-backend
            - build-cli

      # Release jobs (only on main)
      - publish-vs-code-extension:
          filters:
            branches:
              only: main
          requires: [ok-to-deploy]

      - publish-github-release:
          filters:
            branches:
              only: main
          requires: [ok-to-deploy]
