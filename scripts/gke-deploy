#!/usr/bin/env bash
. ./scripts/support/assert-in-container $0 $@

set -euo pipefail

set -x
gcloud container clusters get-credentials darkcluster0


#########################
# Deploy Docker image
#########################
IMAGE_ID=$(docker images dark-gcp -q | head -n 1)
PROJECT="balmy-ground-195100"
IMAGE="gcr.io/$PROJECT/dark-prod:$IMAGE_ID"
echo "Deploying container to GCP"
docker tag dark-gcp:latest $IMAGE
docker-credential-gcr configure-docker
docker push $IMAGE


#########################
# Tell Kubernetes what to do
#########################

# env vars (replace existing configmap or make a new one)
(kubectl create configmap gke-dark-prod --from-env-file config/gke-builtwithdark -o yaml --dry-run | kubectl replace -f -) ||  kubectl create configmap gke-dark-prod --from-env-file config/gke-builtwithdark



# make sure deployment matches current understanding
kubectl apply -f scripts/support/builtwithdark.yaml

# deploy the image
kubectl set image deployment/builtwithdark builtwithdark=$IMAGE
