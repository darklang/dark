#!/usr/bin/env bash
. ./scripts/support/assert-in-container $0 $@

set -euo pipefail

set -x

ROLLBAR_ACCESS_TOKEN="ac042ea56b054bbdbddbfffaa149004e"
ENVIRONMENT=production
LOCAL_USERNAME=`cat ~/.config/gcloud/configurations/config_default | grep 'account' | awk '{print $3}' | awk -F "@" '{print $1}'`
PROJECT="balmy-ground-195100"
ZONE="us-west1"
CLUSTER="darkcluster1"
GCR="gcr.io/$PROJECT"

## Only fetch if we haven't just built, which we do on CI
if [[ "$CI" == "" ]]; then
  echo "Not on CI: fetching latest containers"
  ./scripts/gcp-fetch-latest-containers $PROJECT
else
  echo "On CI: not fetching latest containers"
fi

#########################
# Tell Kubernetes what to do
#########################
IMAGE_ID=$(docker images $GCR/dark-gcp -q | head -n 1)
QW_IMAGE_ID=$(docker images $GCR/dark-gcp-qw -q | head -n 1)
CRON_IMAGE_ID=$(docker images $GCR/dark-gcp-cron -q | head -n 1)
IMAGE="$GCR/dark-gcp:$IMAGE_ID"
QW_IMAGE="$GCR/dark-gcp-qw:$QW_IMAGE_ID"
CRON_IMAGE="$GCR/dark-gcp-cron:$CRON_IMAGE_ID"


# get creds
gcloud container clusters get-credentials projects/$PROJECT/zones/$ZONE/clusters/$CLUSTER --zone=$ZONE

# env vars (replace existing configmap or make a new one)
(kubectl create configmap gke-dark-prod --from-env-file config/gke-builtwithdark -o yaml --dry-run | kubectl replace -f -) ||  kubectl create configmap gke-dark-prod --from-env-file config/gke-builtwithdark
(kubectl create configmap nginx --from-file=scripts/support/nginx.conf -o yaml --dry-run | kubectl replace -f -) ||  kubectl create configmap nginx --from-file=scripts/support/nginx.conf


# make sure deployment matches current understanding
kubectl apply -f scripts/support/builtwithdark.yaml
kubectl apply -f scripts/support/queueworker.yaml
kubectl apply -f scripts/support/cronchecker.yaml

# deploy the image
kubectl set image deployment/bwd-deployment bwd-ctr=$IMAGE
kubectl set image deployment/qw-deployment qw-ctr=$QW_IMAGE
kubectl set image deployment/cron-deployment cron-ctr=$CRON_IMAGE

#########################
# Tell everyone else what's going on
#########################
curl -s https://api.rollbar.com/api/1/deploy/ \
  -F access_token="${ROLLBAR_ACCESS_TOKEN}" \
  -F environment="$ENVIRONMENT" \
  -F revision="$IMAGE" \
  -F local_username="${LOCAL_USERNAME}" > /dev/null
echo "Rollbar notified."


