#!/usr/bin/env bash
. ./scripts/devcontainer/_assert-in-container "$0" "$@"

set -euo pipefail

trap ctrl_c INT

function ctrl_c() {
  killall -9 Tests
  exit 1
}

PUBLISHED=false
PUBLISHED_FLAG=

EXPECTO_ARGS=()

for i in "$@"
do
  case "${i}" in
    --published)
      PUBLISHED=true
      PUBLISHED_FLAG=$i
      ;;
    *) EXPECTO_ARGS+=("${i}");;
  esac
done

killall -9 Tests || true

if [[ "$PUBLISHED" == "true" ]]; then
  EXE=Build/out/Tests/Release/net8.0/linux-x64/Tests
  LOCALEXEC=Build/out/LocalExec/Release/net8.0/linux-x64/LocalExec
else
  EXE=Build/out/Tests/Debug/net8.0/Tests
  LOCALEXEC=Build/out/LocalExec/Debug/net8.0/LocalExec
fi


LOGS="${DARK_CONFIG_RUNDIR}/logs"

grey="\033[1;30m"
reset="\033[0m"


# Delete the database file before running tests
export DARK_CONFIG_DB_NAME=test-data.db
DB_PATH="${DARK_CONFIG_RUNDIR}/${DARK_CONFIG_DB_NAME}"
echo -e "Deleting database file ${grey}(${DB_PATH})${reset}"
rm -f "$DB_PATH"

# Run the migrations before the other servers start
echo -e "Running migrations ${grey}($LOGS/test-migrations.log)${reset}"
cd backend && \
  DARK_CONFIG_TELEMETRY_EXPORTER=none \
  "${LOCALEXEC}" migrations run > "$LOGS/test-migrations.log" 2>&1
cd ..

# Reload packages

if [[ -v CI ]]; then
  echo "Running backend server"
  ./scripts/run-backend-server $PUBLISHED_FLAG
  echo "Reloading packages"
  ./scripts/build/reload-packages $PUBLISHED_FLAG
else
  echo "Reloading packages"
  ./scripts/build/reload-packages --test $PUBLISHED_FLAG
fi

JUNIT_FILE="${DARK_CONFIG_RUNDIR}/test_results/backend.xml"


COLOURS="256"
SPINNER=
if [[ -v CI ]]; then
  # Expecto needs `--colours 0` or the xml will be invalid
  # https://github.com/haf/expecto/issues/434
  COLOURS="0"
  SPINNER="--no-spinner"
fi

TEST_LOG="${LOGS}/fsharp-tests.log"
> "${TEST_LOG}" # truncate
echo -e "Test log: ${grey}${TEST_LOG}${reset}"

cd backend
DARK_CONFIG_TELEMETRY_EXPORTER=none \
"${EXE}" ${SPINNER} --colours "${COLOURS}" --junit-summary "${JUNIT_FILE}" "${EXPECTO_ARGS[@]}" 2>&1 | tee "${TEST_LOG}"
