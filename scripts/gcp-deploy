#/usr/bin/env bash

set -euo pipefail

IMAGE=gcr.io/balmy-ground-195100/dark-prod

docker tag dark-gcp:latest $IMAGE
gcloud docker -- push $IMAGE

gcloud beta compute instances update-container instance-2 \
  --container-image $IMAGE \
  --container-env-file config/prod_gcp \
  --container-mount-host-path mount-path=/home/dark/gcp_persistdir,host-path=/tmp/persistdir,mode=rw \
  --container-mount-host-path mount-path=/home/dark/gcp_rundir,host-path=/tmp/rundir,mode=rw \

# Only needs to be done once, but isn't connected yet
# gcloud compute firewall-rules create allow-http \
#   --allow tcp:80 --target-tags dark-prod

  # --container-restart-policy=always \
  # --no-container-privileged \
  # --no-container-stdin \
  # --no-container-tty

# TODO: persistent storage for postgres and appdata and events

