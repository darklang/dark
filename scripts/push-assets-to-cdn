#! /usr/bin/env bash
set -euo pipefail
set -x

PREFIX_TO_REMOVE="server/static/"

# We're not hashing the files in server/static/vendor
for file in $(find server/static -maxdepth 1 -type f -and -not -name etags.json -and -not -name *.gz); do
    basefile="$(basename "$file")"
    filehash="$(jq -r --arg FILE "${basefile}" '.[$FILE]' server/static/etags.json)"
    hashed_file="${file%.*}-${filehash}.${basefile##*.}"

    tar czvf "${hashed_file}.gz" "$file"

    gsutil cp "${hashed_file}.gz" "gs://darklang-static-assets/${hashed_file//$PREFIX_TO_REMOVE}.gz"
done

# We do want to compress the vendored files, though
for file in $(find server/static -mindepth 2 -type f -and -not -name *.gz); do
    tar czvf "${file}.gz" "${file}"
    gsutil cp "${file}.gz" "gs://darklang-static-assets/${file//$PREFIX_TO_REMOVE}.gz"
done
