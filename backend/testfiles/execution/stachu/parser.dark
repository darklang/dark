// Tests for the Stachu.Parser combinator library
// These tests exercise regex functionality through the parser combinators

module BasicParsers =
  // String parser
  (Stachu.Parser.parse (Stachu.Parser.string "hello") "hello world") = Stachu.Parser.ParseResult.Success("hello", " world")

  (Stachu.Parser.parse (Stachu.Parser.string "hello") "goodbye") = Stachu.Parser.ParseResult.Failure "Expected: \"hello\""

  (Stachu.Parser.parse (Stachu.Parser.string "") "test") = Stachu.Parser.ParseResult.Success("", "test")


module RegexParser =
  // Basic regex matching
  (Stachu.Parser.parse (Stachu.Parser.regex "\\d+") "123abc") = Stachu.Parser.ParseResult.Success("123", "abc")

  (Stachu.Parser.parse (Stachu.Parser.regex "\\d+") "abc123") = Stachu.Parser.ParseResult.Failure "Expected pattern: \\d+"

  (Stachu.Parser.parse (Stachu.Parser.regex "[a-z]+") "hello123") = Stachu.Parser.ParseResult.Success("hello", "123")

  // Word characters
  (Stachu.Parser.parse (Stachu.Parser.regex "\\w+") "hello_world123 test") = Stachu.Parser.ParseResult.Success("hello_world123", " test")

  // Whitespace
  (Stachu.Parser.parse (Stachu.Parser.regex "\\s+") "   hello") = Stachu.Parser.ParseResult.Success("   ", "hello")


module BuiltInParsers =
  // Digits parser
  (Stachu.Parser.parse (Stachu.Parser.digits ()) "42abc") = Stachu.Parser.ParseResult.Success("42", "abc")

  (Stachu.Parser.parse (Stachu.Parser.digits ()) "abc") = Stachu.Parser.ParseResult.Failure "Expected pattern: \\d+"

  // Word parser
  (Stachu.Parser.parse (Stachu.Parser.word ()) "hello123_world!") = Stachu.Parser.ParseResult.Success("hello123_world", "!")

  // Letters parser
  (Stachu.Parser.parse (Stachu.Parser.letters ()) "hello123") = Stachu.Parser.ParseResult.Success("hello", "123")

  // Whitespace parser
  (Stachu.Parser.parse (Stachu.Parser.whitespace ()) "  \t\ntext") = Stachu.Parser.ParseResult.Success("  \t\n", "text")

  // Optional whitespace
  (Stachu.Parser.parse (Stachu.Parser.optionalWhitespace ()) "   text") = Stachu.Parser.ParseResult.Success("   ", "text")

  (Stachu.Parser.parse (Stachu.Parser.optionalWhitespace ()) "text") = Stachu.Parser.ParseResult.Success("", "text")


module NumberParsers =
  // Int64 parser
  (Stachu.Parser.parse (Stachu.Parser.int64 ()) "42 rest") = Stachu.Parser.ParseResult.Success(42L, " rest")

  (Stachu.Parser.parse (Stachu.Parser.int64 ()) "-123abc") = Stachu.Parser.ParseResult.Success(-123L, "abc")

  (Stachu.Parser.parse (Stachu.Parser.int64 ()) "0") = Stachu.Parser.ParseResult.Success(0L, "")

  // Float parser
  (Stachu.Parser.parse (Stachu.Parser.float ()) "3.14 rest") = Stachu.Parser.ParseResult.Success(3.14, " rest")

  (Stachu.Parser.parse (Stachu.Parser.float ()) "-0.5abc") = Stachu.Parser.ParseResult.Success(-0.5, "abc")


module Combinators =
  module Succeed =
    (Stachu.Parser.parse (Stachu.Parser.succeed 42L) "anything") = Stachu.Parser.ParseResult.Success(42L, "anything")

    (Stachu.Parser.parse (Stachu.Parser.succeed "value") "") = Stachu.Parser.ParseResult.Success("value", "")


  module Fail =
    (Stachu.Parser.parse (Stachu.Parser.fail "oops") "input") = Stachu.Parser.ParseResult.Failure "oops"


  module Map =
    // Map over successful parse
    (Stachu.Parser.parse
      (Stachu.Parser.map (fun s -> Stdlib.String.toUppercase s) (Stachu.Parser.string "hello"))
      "hello world") = Stachu.Parser.ParseResult.Success("HELLO", " world")

    // Map with number conversion
    (Stachu.Parser.parse
      (Stachu.Parser.map (fun n -> n * 2L) (Stachu.Parser.int64 ()))
      "21 rest") = Stachu.Parser.ParseResult.Success(42L, " rest")


  module AndThen =
    // Sequence two parsers
    (Stachu.Parser.parse
      (Stachu.Parser.andThen (Stachu.Parser.string "hello") (Stachu.Parser.string " world"))
      "hello world!") = Stachu.Parser.ParseResult.Success(("hello", " world"), "!")

    // First parser fails
    (Stachu.Parser.parse
      (Stachu.Parser.andThen (Stachu.Parser.string "hello") (Stachu.Parser.string " world"))
      "goodbye world") = Stachu.Parser.ParseResult.Failure "Expected: \"hello\""

    // Second parser fails
    (Stachu.Parser.parse
      (Stachu.Parser.andThen (Stachu.Parser.string "hello") (Stachu.Parser.string " world"))
      "hello there") = Stachu.Parser.ParseResult.Failure "Expected: \" world\""


  module OrElse =
    // First parser succeeds
    (Stachu.Parser.parse
      (Stachu.Parser.orElse (Stachu.Parser.string "hello") (Stachu.Parser.string "goodbye"))
      "hello world") = Stachu.Parser.ParseResult.Success("hello", " world")

    // First fails, second succeeds
    (Stachu.Parser.parse
      (Stachu.Parser.orElse (Stachu.Parser.string "hello") (Stachu.Parser.string "goodbye"))
      "goodbye world") = Stachu.Parser.ParseResult.Success("goodbye", " world")

    // Both fail
    (Stachu.Parser.parse
      (Stachu.Parser.orElse (Stachu.Parser.string "hello") (Stachu.Parser.string "goodbye"))
      "greetings") = Stachu.Parser.ParseResult.Failure "Expected: \"goodbye\""


  module KeepLeftRight =
    // Keep left
    (Stachu.Parser.parse
      (Stachu.Parser.keepLeft (Stachu.Parser.word ()) (Stachu.Parser.whitespace ()))
      "hello   world") = Stachu.Parser.ParseResult.Success("hello", "world")

    // Keep right
    (Stachu.Parser.parse
      (Stachu.Parser.keepRight (Stachu.Parser.whitespace ()) (Stachu.Parser.word ()))
      "   hello world") = Stachu.Parser.ParseResult.Success("hello", " world")


module Repetition =
  module Many =
    // Parse multiple digits
    (Stachu.Parser.parse
      (Stachu.Parser.many (Stachu.Parser.regex "\\d"))
      "123abc") = Stachu.Parser.ParseResult.Success([ "1"; "2"; "3" ], "abc")

    // Zero matches is ok
    (Stachu.Parser.parse
      (Stachu.Parser.many (Stachu.Parser.regex "\\d"))
      "abc") = Stachu.Parser.ParseResult.Success([], "abc")


  module Many1 =
    // Parse multiple digits
    (Stachu.Parser.parse
      (Stachu.Parser.many1 (Stachu.Parser.regex "\\d"))
      "123abc") = Stachu.Parser.ParseResult.Success([ "1"; "2"; "3" ], "abc")

    // Zero matches fails
    (Stachu.Parser.parse
      (Stachu.Parser.many1 (Stachu.Parser.regex "\\d"))
      "abc") = Stachu.Parser.ParseResult.Failure "Expected pattern: \\d"


  module Optional =
    // Present
    (Stachu.Parser.parse
      (Stachu.Parser.optional (Stachu.Parser.string "-"))
      "-123") = Stachu.Parser.ParseResult.Success(Stdlib.Option.Option.Some "-", "123")

    // Absent
    (Stachu.Parser.parse
      (Stachu.Parser.optional (Stachu.Parser.string "-"))
      "123") = Stachu.Parser.ParseResult.Success(Stdlib.Option.Option.None, "123")


  module SepBy =
    // Parse comma-separated numbers
    (Stachu.Parser.parse
      (Stachu.Parser.sepBy (Stachu.Parser.digits ()) (Stachu.Parser.string ","))
      "1,2,3 rest") = Stachu.Parser.ParseResult.Success([ "1"; "2"; "3" ], " rest")

    // Single item
    (Stachu.Parser.parse
      (Stachu.Parser.sepBy (Stachu.Parser.digits ()) (Stachu.Parser.string ","))
      "42 rest") = Stachu.Parser.ParseResult.Success([ "42" ], " rest")

    // No items
    (Stachu.Parser.parse
      (Stachu.Parser.sepBy (Stachu.Parser.digits ()) (Stachu.Parser.string ","))
      "abc") = Stachu.Parser.ParseResult.Success([], "abc")


module Between =
  // Parse content between parens
  (Stachu.Parser.parse
    (Stachu.Parser.between (Stachu.Parser.string "(") (Stachu.Parser.string ")") (Stachu.Parser.digits ()))
    "(42) rest") = Stachu.Parser.ParseResult.Success("42", " rest")

  // Parse content between brackets
  (Stachu.Parser.parse
    (Stachu.Parser.between (Stachu.Parser.string "[") (Stachu.Parser.string "]") (Stachu.Parser.word ()))
    "[hello]world") = Stachu.Parser.ParseResult.Success("hello", "world")


module Choice =
  // First parser matches
  (Stachu.Parser.parse
    (Stachu.Parser.choice [ Stachu.Parser.string "a"; Stachu.Parser.string "b"; Stachu.Parser.string "c" ])
    "abc") = Stachu.Parser.ParseResult.Success("a", "bc")

  // Second parser matches
  (Stachu.Parser.parse
    (Stachu.Parser.choice [ Stachu.Parser.string "a"; Stachu.Parser.string "b"; Stachu.Parser.string "c" ])
    "bcd") = Stachu.Parser.ParseResult.Success("b", "cd")

  // Third parser matches
  (Stachu.Parser.parse
    (Stachu.Parser.choice [ Stachu.Parser.string "a"; Stachu.Parser.string "b"; Stachu.Parser.string "c" ])
    "cde") = Stachu.Parser.ParseResult.Success("c", "de")


module QuotedString =
  // Simple quoted string
  (Stachu.Parser.parse (Stachu.Parser.quotedString ()) "\"hello\" world") = Stachu.Parser.ParseResult.Success("hello", " world")

  // Empty quoted string
  (Stachu.Parser.parse (Stachu.Parser.quotedString ()) "\"\" rest") = Stachu.Parser.ParseResult.Success("", " rest")

  // Quoted string with escaped content
  (Stachu.Parser.parse (Stachu.Parser.quotedString ()) "\"hello\\nworld\" rest") = Stachu.Parser.ParseResult.Success("hello\\nworld", " rest")


module RealWorldExamples =
  // Parse a simple assignment: identifier = number
  // identParser = letters()
  // equalsParser = between(optionalWhitespace(), optionalWhitespace(), string("="))
  // assignmentParser = andThen(identParser, keepRight(equalsParser, int64()))
  (Stachu.Parser.parse
    (Stachu.Parser.andThen
      (Stachu.Parser.letters ())
      (Stachu.Parser.keepRight
        (Stachu.Parser.between
          (Stachu.Parser.optionalWhitespace ())
          (Stachu.Parser.optionalWhitespace ())
          (Stachu.Parser.string "="))
        (Stachu.Parser.int64 ())))
    "x = 42") = Stachu.Parser.ParseResult.Success(("x", 42L), "")


  // Parse a list of numbers: [1, 2, 3] - using inline expression
  // openBracket = keepRight(string("["), optionalWhitespace())
  // closeBracket = keepRight(optionalWhitespace(), string("]"))
  // commaSep = between(optionalWhitespace(), optionalWhitespace(), string(","))
  // numberList = between(openBracket, closeBracket, sepBy(int64(), commaSep))
  (Stachu.Parser.parse
    (Stachu.Parser.between
      (Stachu.Parser.keepRight (Stachu.Parser.string "[") (Stachu.Parser.optionalWhitespace ()))
      (Stachu.Parser.keepRight (Stachu.Parser.optionalWhitespace ()) (Stachu.Parser.string "]"))
      (Stachu.Parser.sepBy
        (Stachu.Parser.int64 ())
        (Stachu.Parser.between
          (Stachu.Parser.optionalWhitespace ())
          (Stachu.Parser.optionalWhitespace ())
          (Stachu.Parser.string ","))))
    "[1, 2, 3]") = Stachu.Parser.ParseResult.Success([ 1L; 2L; 3L ], "")


  // Parse email-like pattern using regex
  (Stachu.Parser.parse
    (Stachu.Parser.regex "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}")
    "test@example.com extra") = Stachu.Parser.ParseResult.Success("test@example.com", " extra")

  (Stachu.Parser.parse
    (Stachu.Parser.regex "[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}")
    "user.name+tag@sub.domain.org!") = Stachu.Parser.ParseResult.Success("user.name+tag@sub.domain.org", "!")


  // Parse URL-like pattern
  (Stachu.Parser.parse
    (Stachu.Parser.regex "https?://[a-zA-Z0-9.-]+(?:/[a-zA-Z0-9./_-]*)?")
    "https://example.com/path rest") = Stachu.Parser.ParseResult.Success("https://example.com/path", " rest")

  (Stachu.Parser.parse
    (Stachu.Parser.regex "https?://[a-zA-Z0-9.-]+(?:/[a-zA-Z0-9./_-]*)?")
    "http://test.org other") = Stachu.Parser.ParseResult.Success("http://test.org", " other")
