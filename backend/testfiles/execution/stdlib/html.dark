// aliases and helpers
type HtmlTag = Stdlib.Html.HtmlTag
type Node = Stdlib.Html.Node

let nodeToString (node: Node) : String = Stdlib.Html.nodeToString node

let stringNode (str: String) : Node = Stdlib.Html.stringNode str

let htmlTag
  (n: String)
  (a: List<String * Stdlib.Option.Option<String>>)
  (c: List<Node>)
  : Node =
  Stdlib.Html.htmlTagNode n a c


let tidyHtml (html: String) : String =
  html
  |> Stdlib.String.split "\n"
  |> Stdlib.List.map (fun line -> Stdlib.String.trim line)
  |> Stdlib.String.join ""


// -- basic testing of low-level fns
(htmlTag "div" [] []) |> nodeToString = "<div></div>"

(htmlTag "div" [] [ stringNode "yolo" ]) |> nodeToString = "<div>yolo</div>"

(htmlTag "div" [ ("id", (Stdlib.Option.Option.Some "my-div")) ] [ stringNode "yolo" ]) |> nodeToString =
  "<div id=\"my-div\">yolo</div>"

(htmlTag "div" [] [ htmlTag "button" [] [ stringNode "click me" ] ]) |> nodeToString =
  "<div><button>click me</button></div>"


// -- testing of simple html node helpers
(Stdlib.Html.comment "hello") |> nodeToString = "<!-- hello -->"

// -- testing HTML escaping
Stdlib.Html.escapeHtml "<script>alert('xss')</script>" = "&lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;"

Stdlib.Html.escapeHtml "a & b" = "a &amp; b"

Stdlib.Html.escapeHtml "\"quoted\"" = "&quot;quoted&quot;"

// text() should escape HTML
(Stdlib.Html.text "<script>bad</script>")
|> nodeToString = "&lt;script&gt;bad&lt;/script&gt;"

// stringNode() should NOT escape HTML (for trusted content)
(Stdlib.Html.stringNode "<script>trusted</script>")
|> nodeToString = "<script>trusted</script>"

// Using text() with div to prevent XSS
(Stdlib.Html.div
  []
  [ Stdlib.Html.text "User said: <script>alert('xss')</script>" ])
|> nodeToString = "<div>User said: &lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;</div>"

// -- testing attribute helpers
Stdlib.Html.classes [ "btn"; "btn-primary" ] =
  ("class", Stdlib.Option.Option.Some "btn btn-primary")

Stdlib.Html.style [ ("color", "red"); ("font-size", "14px") ] =
  ("style", Stdlib.Option.Option.Some "color: red; font-size: 14px")

Stdlib.Html.dataAttr "user-id" "123" =
  ("data-user-id", Stdlib.Option.Option.Some "123")

// Using attribute helpers with tags
(Stdlib.Html.div
  [ Stdlib.Html.classes [ "container"; "mx-auto" ]
    Stdlib.Html.dataAttr "testid" "main-container" ]
  [ stringNode "content" ])
|> nodeToString =
  "<div class=\"container mx-auto\" data-testid=\"main-container\">content</div>"

(Stdlib.Html.span
  [ Stdlib.Html.style [ ("color", "blue"); ("font-weight", "bold") ] ]
  [ stringNode "styled text" ])
|> nodeToString = "<span style=\"color: blue; font-weight: bold\">styled text</span>"

(Stdlib.Html.br ()) |> nodeToString = "<br>"
(Stdlib.Html.div [] []) |> nodeToString = "<div></div>"
(Stdlib.Html.span [] []) |> nodeToString = "<span></span>"

(Stdlib.Html.h1 [] []) |> nodeToString = "<h1></h1>"
(Stdlib.Html.h2 [] []) |> nodeToString = "<h2></h2>"
(Stdlib.Html.h3 [] []) |> nodeToString = "<h3></h3>"
(Stdlib.Html.h4 [] []) |> nodeToString = "<h4></h4>"
(Stdlib.Html.h5 [] []) |> nodeToString = "<h5></h5>"
(Stdlib.Html.h6 [] []) |> nodeToString = "<h6></h6>"

(Stdlib.Html.p [] []) |> nodeToString = "<p></p>"
(Stdlib.Html.ul [] []) |> nodeToString = "<ul></ul>"
(Stdlib.Html.ol [] []) |> nodeToString = "<ol></ol>"
(Stdlib.Html.li [] []) |> nodeToString = "<li></li>"

(Stdlib.Html.table [] []) |> nodeToString = "<table></table>"
(Stdlib.Html.tr [] []) |> nodeToString = "<tr></tr>"
(Stdlib.Html.td [] []) |> nodeToString = "<td></td>"
(Stdlib.Html.th [] []) |> nodeToString = "<th></th>"
(Stdlib.Html.tbody [] []) |> nodeToString = "<tbody></tbody>"
(Stdlib.Html.thead [] []) |> nodeToString = "<thead></thead>"
(Stdlib.Html.tfoot [] []) |> nodeToString = "<tfoot></tfoot>"

(Stdlib.Html.caption [] []) |> nodeToString = "<caption></caption>"

(Stdlib.Html.colgroup [] []) |> nodeToString = "<colgroup></colgroup>"
(Stdlib.Html.col [] []) |> nodeToString = "<col>"

(Stdlib.Html.img []) |> nodeToString = "<img>"

(Stdlib.Html.img [ ("src", Stdlib.Option.Option.Some "foo.png") ]) |> nodeToString =
  "<img src=\"foo.png\">"

(Stdlib.Html.svg [] []) |> nodeToString = "<svg></svg>"
(Stdlib.Html.path []) |> nodeToString = "<path></path>"

(Stdlib.Html.i [] []) |> nodeToString = "<i></i>"

(Stdlib.Html.meta [ ("charset", Stdlib.Option.Option.Some "UTF-8") ])
|> nodeToString = "<meta charset=\"UTF-8\">"

(Stdlib.Html.link
  [ ("rel", Stdlib.Option.Option.Some "stylesheet")
    ("href", Stdlib.Option.Option.Some "./style.css") ])
|> nodeToString = "<link rel=\"stylesheet\" href=\"./style.css\">"

(Stdlib.Html.script
  [ ("src", Stdlib.Option.Option.Some "https://cdn.tailwindcss.com") ]
  [])
|> nodeToString = "<script src=\"https://cdn.tailwindcss.com\"></script>"

(Stdlib.Html.form [ ("id", Stdlib.Option.Option.Some "my-form") ] [])
|> nodeToString = "<form id=\"my-form\"></form>"

(Stdlib.Html.input
  [ ("type", Stdlib.Option.Option.Some "text")
    ("name", Stdlib.Option.Option.Some "name")
    ("id", Stdlib.Option.Option.Some "name") ])
|> nodeToString = "<input type=\"text\" name=\"name\" id=\"name\">"

(Stdlib.Html.label
  [ ("for", Stdlib.Option.Option.Some "name") ]
  [ stringNode "Name" ])
|> nodeToString = "<label for=\"name\">Name</label>"

(Stdlib.Html.section [] []) |> nodeToString = "<section></section>"

// code
(Stdlib.Html.code [] []) |> nodeToString = "<code></code>"
(Stdlib.Html.pre [] []) |> nodeToString = "<pre></pre>"

(Stdlib.Html.nav [] []) |> nodeToString = "<nav></nav>"
(Stdlib.Html.footer [] []) |> nodeToString = "<footer></footer>"

// Semantic HTML5 tags
(Stdlib.Html.article [] []) |> nodeToString = "<article></article>"
(Stdlib.Html.aside [] []) |> nodeToString = "<aside></aside>"
(Stdlib.Html.header [] []) |> nodeToString = "<header></header>"
(Stdlib.Html.main [] []) |> nodeToString = "<main></main>"
(Stdlib.Html.figure [] []) |> nodeToString = "<figure></figure>"
(Stdlib.Html.figcaption [] []) |> nodeToString = "<figcaption></figcaption>"

// Media tags
(Stdlib.Html.video [] []) |> nodeToString = "<video></video>"
(Stdlib.Html.audio [] []) |> nodeToString = "<audio></audio>"
(Stdlib.Html.picture [] []) |> nodeToString = "<picture></picture>"

// Text formatting tags
(Stdlib.Html.strong [] []) |> nodeToString = "<strong></strong>"
(Stdlib.Html.em [] []) |> nodeToString = "<em></em>"
(Stdlib.Html.b [] []) |> nodeToString = "<b></b>"
(Stdlib.Html.u [] []) |> nodeToString = "<u></u>"
(Stdlib.Html.small [] []) |> nodeToString = "<small></small>"
(Stdlib.Html.mark [] []) |> nodeToString = "<mark></mark>"
(Stdlib.Html.del [] []) |> nodeToString = "<del></del>"
(Stdlib.Html.ins [] []) |> nodeToString = "<ins></ins>"

// Definition list tags
(Stdlib.Html.dl [] []) |> nodeToString = "<dl></dl>"
(Stdlib.Html.dt [] []) |> nodeToString = "<dt></dt>"
(Stdlib.Html.dd [] []) |> nodeToString = "<dd></dd>"

// Form elements
(Stdlib.Html.textarea [] []) |> nodeToString = "<textarea></textarea>"
(Stdlib.Html.select [] []) |> nodeToString = "<select></select>"
(Stdlib.Html.option [] []) |> nodeToString = "<option></option>"
(Stdlib.Html.fieldset [] []) |> nodeToString = "<fieldset></fieldset>"
(Stdlib.Html.legend [] []) |> nodeToString = "<legend></legend>"

// Interactive elements
(Stdlib.Html.details [] []) |> nodeToString = "<details></details>"
(Stdlib.Html.summary [] []) |> nodeToString = "<summary></summary>"
(Stdlib.Html.dialog [] []) |> nodeToString = "<dialog></dialog>"

// -- test whitespace handling between inline elements

// This demonstrates the whitespace issue: when you want spaces between inline elements
// You need to explicitly add whitespace nodes
(Stdlib.Html.div
  []
  [ Stdlib.Html.span [] [ stringNode "foo" ]
    stringNode " "
    Stdlib.Html.span [] [ stringNode "bar" ] ])
|> nodeToString = "<div><span>foo</span> <span>bar</span></div>"

// Without the explicit whitespace node, elements run together
(Stdlib.Html.div
  []
  [ Stdlib.Html.span [] [ stringNode "foo" ]
    Stdlib.Html.span [] [ stringNode "bar" ] ])
|> nodeToString = "<div><span>foo</span><span>bar</span></div>"


// Form with new elements
(Stdlib.Html.form
  []
  [ Stdlib.Html.fieldset
      []
      [ Stdlib.Html.legend [] [ stringNode "User Info" ]
        Stdlib.Html.label [] [ stringNode "Name:" ]
        Stdlib.Html.input [ ("type", Stdlib.Option.Option.Some "text") ]
        Stdlib.Html.label [] [ stringNode "Bio:" ]
        Stdlib.Html.textarea [] [] ] ])
|> nodeToString = ("<form><fieldset><legend>User Info</legend>"
                   ++ "<label>Name:</label><input type=\"text\">"
                   ++ "<label>Bio:</label><textarea></textarea></fieldset></form>")

// Definition list
(Stdlib.Html.dl
  []
  [ Stdlib.Html.dt [] [ stringNode "Term" ]
    Stdlib.Html.dd [] [ stringNode "Definition" ] ])
|> nodeToString = "<dl><dt>Term</dt><dd>Definition</dd></dl>"

// Text formatting
(Stdlib.Html.p
  []
  [ stringNode "This is "
    Stdlib.Html.strong [] [ stringNode "bold" ]
    stringNode " and this is "
    Stdlib.Html.em [] [ stringNode "italic" ]
    stringNode "." ])
|> nodeToString = "<p>This is <strong>bold</strong> and this is <em>italic</em>.</p>"

// Semantic article structure
(Stdlib.Html.article
  []
  [ Stdlib.Html.header [] [ Stdlib.Html.h1 [] [ stringNode "Article Title" ] ]
    Stdlib.Html.p [] [ stringNode "Article content" ]
    Stdlib.Html.footer [] [ stringNode "By Author" ] ])
|> nodeToString = ("<article><header><h1>Article Title</h1></header>"
                   ++ "<p>Article content</p><footer>By Author</footer></article>")

// -- test writing out a full document

([ Stdlib.Html.html
     []
     [ Stdlib.Html.head [] [ Stdlib.Html.title [] [ stringNode "Darklang.com" ] ]

       Stdlib.Html.body [] [ Stdlib.Html.p [] [ stringNode "welcome to darklang" ] ] ] ]
 |> Stdlib.Html.document) = ("<!DOCTYPE html>
    <html>
      <head><title>Darklang.com</title></head>
      <body><p>welcome to darklang</p></body>
    </html>"
                             |> tidyHtml)

// -- test creating a complete webpage with DOCTYPE
([ Stdlib.Html.html [] [] ] |> Stdlib.Html.document |> Stdlib.String.contains
   "<!DOCTYPE html><html></html>") = true